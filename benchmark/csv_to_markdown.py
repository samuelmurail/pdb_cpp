#!/usr/bin/env python3
# coding: utf-8

"""Convert benchmark CSV output to a Markdown table.

Usage examples
--------------
python benchmark/csv_to_markdown.py
python benchmark/csv_to_markdown.py --input benchmark/dockq_vs_pdb_cpp.csv --output benchmark/dockq_vs_pdb_cpp.md
"""

from __future__ import annotations

import argparse
import csv
from pathlib import Path


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(description="Convert benchmark CSV to Markdown table")
    parser.add_argument(
        "--input",
        default="benchmark/dockq_vs_pdb_cpp.csv",
        help="Input CSV generated by compare_dockq_speed.py",
    )
    parser.add_argument(
        "--output",
        default="benchmark/dockq_vs_pdb_cpp.md",
        help="Output Markdown file",
    )
    return parser.parse_args()


def fmt_float(value: str, digits: int = 6) -> str:
    return f"{float(value):.{digits}f}"


def main() -> None:
    args = parse_args()

    input_path = Path(args.input)
    output_path = Path(args.output)

    with input_path.open("r", encoding="utf-8", newline="") as handle:
        rows = list(csv.DictReader(handle))

    if not rows:
        raise ValueError(f"No rows found in {input_path}")

    headers = [
        "Pair",
        "DockQ mean (s)",
        "DockQ median (s)",
        "pdb_cpp mean (s)",
        "pdb_cpp median (s)",
        "Speedup (DockQ/pdb_cpp)",
        "Runs",
        "Warmup",
        "Mode",
    ]

    lines = [
        "| " + " | ".join(headers) + " |",
        "| " + " | ".join(["---"] * len(headers)) + " |",
    ]

    for row in rows:
        values = [
            row["pair"],
            fmt_float(row["dockq_mean_s"]),
            fmt_float(row["dockq_median_s"]),
            fmt_float(row["pdb_cpp_mean_s"]),
            fmt_float(row["pdb_cpp_median_s"]),
            f"{float(row['speedup_dockq_over_pdb_cpp']):.2f}x",
            row["runs"],
            row["warmup"],
            row["mode"],
        ]
        lines.append("| " + " | ".join(values) + " |")

    output_path.parent.mkdir(parents=True, exist_ok=True)
    output_path.write_text("\n".join(lines) + "\n", encoding="utf-8")

    print(f"Markdown table written to: {output_path}")


if __name__ == "__main__":
    main()
